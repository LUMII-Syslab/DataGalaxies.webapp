<html>
<head>
<link href="/dropzone/downloads/css/dropzone.css" type="text/css" rel="stylesheet" />
<!--<link href="/dropzone/downloads/css/basic.css" type="text/css" rel="stylesheet" />-->
<script src="/dropzone/downloads/dropzone.js"></script>

<script src="/tda.js"></script>
<script src="/jquery-1.11.1.min.js"></script>

<style type="text/css">
        form
        {
            height: 5%;
            overflow: hidden;
        }
</style>
</head>
<body>

Star name: <input type="edit" id="starName" value="Protein Data Bank"/>
<p>
Choose .pdb file:
<!--div id="my-awesome-dropzone">Drop files here or click here for upload</div-->

<form style="height: 5%"
      id="my-awesome-dropzone"></form>

<script>
  var prevFileName = null;
  var fileName = null;
  var myDropZone = null;

$(document).ready(function() {

  $("#my-awesome-dropzone").attr("action", "/fileupload/"+tda.cloudLocation);
  $("#my-awesome-dropzone").attr("class", "dropzone");

  var options = {
    url: "/fileupload/"+tda.cloudLocation,
    maxFiles: 1,    
    init: function() {
      this.on("success", function(file) {
        alert("file uploaded "+file.name); 
        // Create the remove button
        var removeButton = Dropzone.createElement("<button>Remove file</button>");
        var _this = this;
        removeButton.addEventListener("click", function(e) {
          e.preventDefault();
          e.stopPropagation();
          tda.fileDelete(file.name);  
          _this.removeFile(file);
          fileName = null;
        });

        file.previewElement.appendChild(removeButton);

        fileName = file.name;

        if (prevFileName) {
          tda.fileDelete(prevFileName);  
          prevFileName = null;
        }

      });
/*      this.on("addedfile", function(file) {

        // Create the remove button
        var removeButton = Dropzone.createElement("<button>Remove file</button>");
        var _this = this;
        removeButton.addEventListener("click", function(e) {
          e.preventDefault();
          e.stopPropagation();
          tda.fileDelete(file.name);  
          _this.removeFile(file);
        });

        file.previewElement.appendChild(removeButton);
      });*/
    },
    accept: function(file, done) {
/*      if ( (file.name.indexOf(".pdb", file.name.length - 4) == -1) &&
           (file.name.indexOf(".PDB", file.name.length - 4) == -1)
         ) {
        done("Not a .pdb file");
      }
      else*/ { done(); }
    }
  };

//  var myDropzone = new Dropzone("div#my-awesome-dropzone", options);
  myDropZone = new Dropzone("form#my-awesome-dropzone", options);
  Dropzone.options.myAwesomeDropzone = options;
});

</script>

<!--<p>
<input id="finput" name="finput2" type="file" accept=".pdb" onchange='$("#selectedFileDiv").html(this.files[0].name+" chosen for upload")'/>
<br>
<div id="selectedFileDiv">
</div>-->


<script>

function load(star)
{

  star = tda.jsonsubmit("loadObjects", {
      navigationExpression : ".starData.*",
      objects : [star]
    }
  )[0];

  if (star.name)
    $("#starName").value = star.name;

//  if (star.starData[0].fileName) {
//    $("#selectedFileDiv").html(star.starData[0].fileName+" uploaded earlier");
//  }
  alert("prev file name "+prevFileName);
}

function store(star)
{
  star.name = document.getElementById("starName").value;
  if (!star.name)
    star.state = "CONFIGURATION_ERROR";

//alert("bool "+(myDropZone.getUploadingFiles().length==0));
  alert(JSON.stringify(myDropZone.getUploadingFiles()));

for (var i=0; i<myDropZone.getAcceptedFiles().length; i++) {
  alert(JSON.stringify(myDropZone.getAcceptedFiles()[i].name));
}
/*  if (document.getElementById("finput").files[0]) {
    // a new file has been chosen...

    // deleting previous file, if any
    if (star.starData[0].fileName) {
      tda.fileDelete(star.starData[0].fileName);  
      delete star.starData[0].fileName;
    }

//    tda.fileUploadAsync(finput);
    star.starData[0].fileName = fileName;//document.getElementById("finput").files[0].name;
  }*/
  star.starData[0].fileName = fileName;
}

function finalize()
{

  alert("pdf fin");
}

</script>


</body>
</html>
